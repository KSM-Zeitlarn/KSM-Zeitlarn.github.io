Sub Mehrzweckhalle_CSV_UTF8_Sicher()
    Dim wsZiel As Worksheet
    Dim letzteZeileZiel As Long
    Dim dateipfad As String
    Dim dateiname As String
    Dim inhalt As String
    Dim zeilen() As String
    Dim zeile As String
    Dim zeilenArray() As String
    Dim headerOrt As String, headerRaum As String
    Dim i As Long

    ' Ziel-Arbeitsblatt
    Set wsZiel = ThisWorkbook.Sheets("Tabelle2")

    ' Letzte freie Zeile in Spalte B
    letzteZeileZiel = wsZiel.Cells(wsZiel.Rows.Count, 2).End(xlUp).Row + 1
    If wsZiel.Cells(1, 2).Value = "" Then letzteZeileZiel = 1

    ' Dateipfad
    dateiname = "Zählerstände-Mehrzweckhalle.csv"
    dateipfad = ThisWorkbook.Path & "\" & dateiname

    ' Datei prüfen
    If Dir(dateipfad) = "" Then
        MsgBox "CSV-Datei nicht gefunden: " & dateipfad, vbCritical
        Exit Sub
    End If

    ' Inhalt mit ADODB.Stream einlesen (UTF-8 BOM-sicher)
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    stream.Charset = "utf-8"
    stream.Open
    stream.LoadFromFile dateipfad
    inhalt = stream.ReadText
    stream.Close
    Set stream = Nothing

    ' Zeilenumbrüche vereinheitlichen
    inhalt = Replace(inhalt, vbCrLf, vbLf)
    zeilen = Split(inhalt, vbLf)

    ' Header aus erster Zeile lesen
    If UBound(zeilen) >= 0 Then
        zeilenArray = Split(zeilen(0), ";")
        If UBound(zeilenArray) >= 1 Then
            headerOrt = Trim(zeilenArray(0))
            headerRaum = Trim(zeilenArray(1))
        Else
            MsgBox "Ungültige Header-Zeile.", vbCritical
            Exit Sub
        End If
    Else
        MsgBox "Die CSV-Datei ist leer.", vbCritical
        Exit Sub
    End If

    ' Ab Zeile 1 (zweite Zeile der Datei) beginnen
    For i = 1 To UBound(zeilen)
        zeile = Trim(zeilen(i))
        If zeile <> "" Then
            zeilenArray = Split(zeile, ";")
            If UBound(zeilenArray) >= 2 Then
                If Trim(zeilenArray(2)) <> "" Then
                    wsZiel.Cells(letzteZeileZiel, 1).Value = Date
                    wsZiel.Cells(letzteZeileZiel, 2).Value = headerOrt
                    wsZiel.Cells(letzteZeileZiel, 3).Value = headerRaum
                    wsZiel.Cells(letzteZeileZiel, 4).Value = Trim(zeilenArray(1))
                    wsZiel.Cells(letzteZeileZiel, 5).Value = Trim(zeilenArray(2))
                    wsZiel.Cells(letzteZeileZiel, 6).Value = headerOrt & headerRaum & Trim(zeilenArray(1))
                    letzteZeileZiel = letzteZeileZiel + 1
                End If
            End If
        End If
    Next i

    MsgBox "CSV-Daten erfolgreich übertragen!", vbInformation
End Sub
